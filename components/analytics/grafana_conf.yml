http:
  routers:
    grafana:
      entryPoints:
      - web
      middlewares:
      - strip-editview
      - analytics-auth
      service: grafana
      rule: Host(`{{ env "CVAT_HOST" }}`) && PathPrefix(`/analytics`)
    grafana_https:
      entryPoints:
      - websecure
      middlewares:
      - strip-editview
      - analytics-auth
      service: grafana
      tls: {}
      rule: Host(`{{ env "CVAT_HOST" }}`) && PathPrefix(`/analytics`)

  middlewares:
    strip-editview:
      redirectRegex:
        regex: "^(https?://[^/]+/analytics/).*([\\?&]editview=[^&#]*).*"
        replacement: "$1"
        permanent: false
    analytics-auth:
      forwardauth:
        address: http://cvat_server:8080/analytics
        authRequestHeaders:
          - "Cookie"
          - "Authorization"

  services:
    grafana:
      loadBalancer:
        servers:
        - url: http://{{ env "DJANGO_LOG_VIEWER_HOST" }}:{{ env "DJANGO_LOG_VIEWER_PORT" }}
        passHostHeader: true
